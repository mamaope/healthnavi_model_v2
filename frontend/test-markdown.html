<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Test - HealthNavi</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .test-container {
            border: 2px solid var(--border-light);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background: var(--bg-secondary);
        }
        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 500;
        }
        button:hover {
            opacity: 0.9;
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        .output {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border-light);
        }
        .status {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin: 10px 0;
        }
        .status p {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }
        .status .success {
            color: #059669;
        }
        .status .error {
            color: #dc2626;
        }
    </style>
</head>
<body>
    <h1>Markdown Rendering Test</h1>
    <p class="subtitle">Test the markdown renderer with real AI responses</p>
    
    <div class="test-container">
        <h2>Libraries Status</h2>
        <div class="status">
            <p id="markedStatus"></p>
            <p id="purifyStatus"></p>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Test Samples</h2>
        <button onclick="testRealResponse()">Test CORRECTED AI Response (With Blank Lines)</button>
        <button onclick="testOldResponse()">Test OLD AI Response (No Blank Lines)</button>
        <button onclick="testSimpleMarkdown()">Test Simple Markdown</button>
        <button onclick="testComplexMarkdown()">Test Complex Markdown</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div class="output">
        <h3 style="margin-bottom: 20px;">Output Preview:</h3>
        <div class="message ai-message" id="output">
            <div class="message-content">
                <p>Click a test button to see rendered markdown</p>
            </div>
        </div>
    </div>

    <!-- Markdown Parser and Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    
    <script>
        // Check library status
        const markedLoaded = typeof marked !== 'undefined';
        const purifyLoaded = typeof DOMPurify !== 'undefined';
        
        document.getElementById('markedStatus').innerHTML = markedLoaded 
            ? '<span class="success">‚úÖ marked.js: Loaded (v' + (marked.version || 'unknown') + ')</span>'
            : '<span class="error">‚ùå marked.js: NOT loaded</span>';
            
        document.getElementById('purifyStatus').innerHTML = purifyLoaded
            ? '<span class="success">‚úÖ DOMPurify: Loaded (v' + (DOMPurify.version || 'unknown') + ')</span>'
            : '<span class="error">‚ùå DOMPurify: NOT loaded</span>';
        
        // Real response from your AI (with HTML entities)
        // OLD AI response WITHOUT proper blank lines (this is what was returned before)
        const realAIResponseOld = `**CRITICAL ALERT üö®** The patient presents with acute-onset chest pain, diaphoresis, and hyperacute T-waves, which are highly suggestive of acute myocardial ischemia/infarction. Immediate cardiac evaluation and intervention are critical. ## üè• Clinical Overview A 65-year-old woman with a history of diabetes and hyperlipidemia presents with acute-onset chest pain and diaphoresis. Electrocardiogram (ECG) findings show hyperacute T-waves without ST elevation. These symptoms and ECG findings are concerning for acute myocardial ischemia or infarction. ## üîç Differential Diagnoses 1. **Acute Myocardial Infarction (MI)** (90%): The patient&#x27;s symptoms of acute-onset chest pain and diaphoresis, combined with a history of diabetes and hyperlipidemia (risk factors for ischemic heart disease), and ECG findings of hyperacute T-waves, are highly suggestive of myocardial infarction. &quot;Tall T waves can be an early sign in myocardial infarction&quot; [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116]. 2. **Hyperkalemia** (10%): Hyperkalemia can present with characteristic ECG changes. &quot;In hyperkalemia, the T waves are usually of high voltage and are tent shaped&quot; [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116]. While the patient&#x27;s primary complaint is chest pain and diaphoresis, the ECG finding of hyperacute T-waves warrants consideration of this electrolyte abnormality. ## üî¨ Immediate Workup &amp; Investigations - **Serum Potassium Measurement**: To assess for hyperkalemia, given the ECG finding of high voltage/tent-shaped T-waves [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116]. - **Further Diagnostic Measurements**: The text indicates that &quot;Diagnosis during pregnancy is not different from the nonpregnant patient. Measurement of...&quot; is important, implying specific diagnostic measurements are crucial for myocardial infarction, though the specific measurement is not detailed in the provided text [Source: Williams Obstetrics-1376hlm.pdf, Page: 1013]. ## ‚öïÔ∏è Management &amp; Recommendations - No specific management protocols for acute myocardial infarction or hyperkalemia are detailed in the provided reference text. ## üö© Red Flags / Danger Signs - Acute-onset chest pain - Diaphoresis - Hyperacute T-waves on ECG ## ‚ùì Additional Information Needed What specific &quot;Measurement of...&quot; is referenced for the diagnosis of myocardial infarction in non-pregnant patients? ## üìö Sources Nelson Textbook of Pediatrics, 21st Edition.pdf (Page: 4116), Williams Obstetrics-1376hlm.pdf (Page: 1013)`;

        // CORRECTED AI response WITH proper blank lines (this is what the new prompts should produce)
        const realAIResponse = `**CRITICAL ALERT üö®** The patient presents with acute-onset chest pain, diaphoresis, and hyperacute T-waves, which are highly suggestive of acute myocardial ischemia/infarction. Immediate cardiac evaluation and intervention are critical.

## üè• Clinical Overview

A 65-year-old woman with a history of diabetes and hyperlipidemia presents with acute-onset chest pain and diaphoresis. Electrocardiogram (ECG) findings show hyperacute T-waves without ST elevation. These symptoms and ECG findings are concerning for acute myocardial ischemia or infarction.

## üîç Differential Diagnoses

1. **Acute Myocardial Infarction (MI)** (90%): The patient's symptoms of acute-onset chest pain and diaphoresis, combined with a history of diabetes and hyperlipidemia (risk factors for ischemic heart disease), and ECG findings of hyperacute T-waves, are highly suggestive of myocardial infarction. "Tall T waves can be an early sign in myocardial infarction" [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116].

2. **Hyperkalemia** (10%): Hyperkalemia can present with characteristic ECG changes. "In hyperkalemia, the T waves are usually of high voltage and are tent shaped" [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116]. While the patient's primary complaint is chest pain and diaphoresis, the ECG finding of hyperacute T-waves warrants consideration of this electrolyte abnormality.

## üî¨ Immediate Workup & Investigations

- **Serum Potassium Measurement**: To assess for hyperkalemia, given the ECG finding of high voltage/tent-shaped T-waves [Source: Nelson Textbook of Pediatrics, 21st Edition.pdf, Page: 4116].
- **Further Diagnostic Measurements**: The text indicates that "Diagnosis during pregnancy is not different from the nonpregnant patient. Measurement of..." is important, implying specific diagnostic measurements are crucial for myocardial infarction, though the specific measurement is not detailed in the provided text [Source: Williams Obstetrics-1376hlm.pdf, Page: 1013].

## ‚öïÔ∏è Management & Recommendations

- No specific management protocols for acute myocardial infarction or hyperkalemia are detailed in the provided reference text.

## üö© Red Flags / Danger Signs

- Acute-onset chest pain
- Diaphoresis
- Hyperacute T-waves on ECG

## ‚ùì Additional Information Needed

What specific "Measurement of..." is referenced for the diagnosis of myocardial infarction in non-pregnant patients?

## üìö Sources

Nelson Textbook of Pediatrics, 21st Edition.pdf (Page: 4116), Williams Obstetrics-1376hlm.pdf (Page: 1013)`;

        const simpleMarkdown = `## üè• Clinical Overview

This is a simple test of markdown rendering.

## üîç Differential Diagnoses

1. **First Diagnosis** (80%): This is the most likely diagnosis
2. **Second Diagnosis** (15%): This is less likely
3. **Third Diagnosis** (5%): This is rare

## Treatment Options

- Option 1: First-line treatment
- Option 2: Alternative treatment
- Option 3: Last resort

> **Note:** This is an important warning.`;

        const complexMarkdown = `## üè• Clinical Assessment

Patient presents with multiple concerning symptoms requiring immediate evaluation.

### Key Findings

- **Vital Signs**: BP 140/90, HR 95, RR 22, Temp 38.2¬∞C
- **Physical Exam**: Notable findings include...

## üîç Differential Diagnoses

1. **Acute Coronary Syndrome** (75%): Given the chest pain, diaphoresis, and ECG changes
2. **Pulmonary Embolism** (15%): Must be ruled out given dyspnea
3. **Aortic Dissection** (10%): Less likely but life-threatening

## üî¨ Immediate Workup

### Laboratory Tests
- Cardiac enzymes (troponin, CK-MB)
- D-dimer
- CBC, BMP

### Imaging
- ECG (12-lead)
- Chest X-ray
- Consider CT angiography

## ‚öïÔ∏è Management

1. **Immediate Actions**:
   - Oxygen supplementation if SpO2 < 94%
   - IV access (2 large-bore)
   - Continuous cardiac monitoring

2. **Medications**:
   - Aspirin 325mg PO
   - Nitroglycerin SL PRN
   - Morphine for pain control

> **CRITICAL:** Monitor for signs of cardiogenic shock or arrhythmias.

## üìä Risk Stratification

| Factor | Present | Score |
|--------|---------|-------|
| Age > 65 | Yes | 1 |
| Diabetes | Yes | 1 |
| Prior MI | No | 0 |

**Total Risk Score:** 2/3 (Moderate-High)

## üìö Sources

- ACC/AHA Guidelines for STEMI Management
- ESC Guidelines for Acute Coronary Syndromes`;

        function decodeHTMLEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        function renderMarkdownWithEnhancements(markdown) {
            if (!markedLoaded || !purifyLoaded) {
                return '<p class="error">‚ùå Markdown libraries not loaded</p>';
            }
            
            console.log('üìù Rendering markdown...');
            console.log('Input length:', markdown.length);
            
            // Decode HTML entities first
            const decodedMarkdown = decodeHTMLEntities(markdown);
            console.log('Decoded markdown preview:', decodedMarkdown.substring(0, 200));
            
            // Configure marked
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false,
                pedantic: false,
                sanitize: false,
                smartLists: true,
                smartypants: true
            });
            
            // Parse markdown
            const html = marked.parse(decodedMarkdown);
            console.log('Parsed HTML preview:', html.substring(0, 200));
            
            // Sanitize
            const cleanHtml = DOMPurify.sanitize(html);
            console.log('Clean HTML length:', cleanHtml.length);
            
            return cleanHtml;
        }
        
        function testRealResponse() {
            console.log('Testing CORRECTED AI response with blank lines...');
            const output = document.querySelector('#output .message-content');
            const rendered = renderMarkdownWithEnhancements(realAIResponse);
            output.innerHTML = rendered;
            console.log('‚úÖ Corrected response rendered');
        }
        
        function testOldResponse() {
            console.log('Testing OLD AI response without blank lines...');
            const output = document.querySelector('#output .message-content');
            const rendered = renderMarkdownWithEnhancements(realAIResponseOld);
            output.innerHTML = rendered;
            console.log('‚ö†Ô∏è Old response rendered (will look broken)');
        }
        
        function testSimpleMarkdown() {
            console.log('Testing simple markdown...');
            const output = document.querySelector('#output .message-content');
            const rendered = renderMarkdownWithEnhancements(simpleMarkdown);
            output.innerHTML = rendered;
            console.log('‚úÖ Simple markdown rendered');
        }
        
        function testComplexMarkdown() {
            console.log('Testing complex markdown...');
            const output = document.querySelector('#output .message-content');
            const rendered = renderMarkdownWithEnhancements(complexMarkdown);
            output.innerHTML = rendered;
            console.log('‚úÖ Complex markdown rendered');
        }
        
        function clearOutput() {
            const output = document.querySelector('#output .message-content');
            output.innerHTML = '<p>Click a test button to see rendered markdown</p>';
        }
    </script>
</body>
</html>

